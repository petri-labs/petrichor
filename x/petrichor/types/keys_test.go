package types_test

import (
	sdk "github.com/cosmos/cosmos-sdk/types"
	"github.com/stretchr/testify/require"
	"github.com/petrinetwork/petrichor/x/petrichor/types"
	"testing"
	"time"
)

func TestRedelegationKey(t *testing.T) {
	delAddr, err := sdk.AccAddressFromHexUnsafe("aa")
	require.NoError(t, err)
	valAddr, err := sdk.ValAddressFromHex("bb")
	require.NoError(t, err)
	completion := time.Now().UTC()
	key := types.GetRedelegationKey(delAddr, "denom", valAddr, completion)
	parsedCompletion := types.ParseRedelegationKeyForCompletionTime(key)
	require.Equal(t, completion, parsedCompletion)
}

func TestRedelegationQueueKey(t *testing.T) {
	completion := time.Now().UTC()
	key := types.GetRedelegationQueueKey(completion)
	parsedCompletion := types.ParseRedelegationQueueKey(key)
	require.Equal(t, completion, parsedCompletion)
}

func TestRedelegationIndex(t *testing.T) {
	delAddr, err := sdk.AccAddressFromHexUnsafe("aa")
	require.NoError(t, err)
	srcValAddr, err := sdk.ValAddressFromHex("bb")
	require.NoError(t, err)
	dstValAddr, err := sdk.ValAddressFromHex("bb")
	require.NoError(t, err)
	completion := time.Now().UTC()
	denom := "token"
	indexKey := types.GetRedelegationIndexKey(srcValAddr, completion, denom, dstValAddr, delAddr)
	parsedDelKey, parsedTime, err := types.ParseRedelegationIndexForRedelegationKey(indexKey)
	require.NoError(t, err)
	require.Equal(t, parsedTime, completion)
	delKey := types.GetRedelegationKey(delAddr, denom, dstValAddr, completion)
	require.Equal(t, parsedDelKey, delKey)
}

func TestUndelegationIndex(t *testing.T) {
	delAddr, err := sdk.AccAddressFromHexUnsafe("aa")
	require.NoError(t, err)
	srcValAddr, err := sdk.ValAddressFromHex("bb")
	require.NoError(t, err)
	completion := time.Now().UTC()
	denom := "token"

	indexKey := types.GetUnbondingIndexKey(srcValAddr, completion, denom, delAddr)
	parsedUndelKey, parsedTime, err := types.ParseUnbondingIndexKeyToUndelegationKey(indexKey)
	require.NoError(t, err)
	require.Equal(t, parsedTime, completion)
	delKey := types.GetUndelegationQueueKey(completion, delAddr)
	require.Equal(t, delKey, parsedUndelKey)
}

func TestRewardWeightDecayQueueKey(t *testing.T) {
	triggerTime := time.Now().UTC()
	key := types.GetRewardWeightDecayQueueKey(triggerTime, "denom")
	parsedTime, denom := types.ParseRewardWeightDecayQueueKeyForDenom(key)
	require.Equal(t, "denom", denom)
	require.Equal(t, triggerTime, parsedTime)
}

func TestRewardSnapshotKey(t *testing.T) {
	denom := "denom"
	valAddr, err := sdk.ValAddressFromHex("bb")
	require.NoError(t, err)
	height := uint64(100)
	key := types.GetRewardWeightChangeSnapshotKey(denom, valAddr, height)

	parsedDenom, parsedValAddr, parsedHeight := types.ParseRewardWeightChangeSnapshotKey(key)
	require.Equal(t, denom, parsedDenom)
	require.Equal(t, valAddr, parsedValAddr)
	require.Equal(t, height, parsedHeight)
}

func TestValidatorKey(t *testing.T) {
	valAddr, err := sdk.ValAddressFromHex("bb")
	require.NoError(t, err)
	key := types.GetPetrichorValidatorInfoKey(valAddr)

	parseValAddr := types.ParsePetrichorValidatorKey(key)
	require.Equal(t, parseValAddr, valAddr)
}